# This file contains common pin mappings for Smoothieboard. To use
# this config, the firmware should be compiled for the LPC176x.

# The "make flash" command does not work on the Smoothieboard.
# Instead, after running "make", copy the generated "out/klipper.bin"
# file to a file named "firmware.bin" on an SD card and then restart
# the Smoothieboard with that SD card.

# See the example.cfg file for a description of available parameters.

[stepper_x]
step_pin: P2.0
dir_pin: !P0.5
# X axis is 
enable_pin: !P0.4
step_distance: .0125
endstop_pin: ^P1.24
#endstop_pin: ^P1.25
position_endstop: 0
position_max: 300
homing_speed: 50

[stepper_y]
step_pin: P2.1
dir_pin: !P0.11
enable_pin: !P0.10
step_distance: .0125
endstop_pin: ^P1.26
#endstop_pin: ^P1.27
position_endstop: 0
position_max: 290
homing_speed: 50

[stepper_z]
step_pin: P2.2
dir_pin: P0.20
enable_pin: !P0.19
step_distance: .0025
endstop_pin: ^P1.28
#endstop_pin: ^P1.29
position_endstop: 0.5
position_max: 400

[extruder]
step_pin: P2.3
dir_pin: !P0.22
enable_pin: !P0.21
# nominal 830 steps/mm 0.9deg/step motor, 16 usteps 
step_distance: 0.00120481927
nozzle_diameter: 0.600
filament_diameter: 1.750
heater_pin: P2.7
sensor_type: ATC Semitec 104GT-2
sensor_pin: P0.23
control: pid
pid_Kp: 37.469
pid_Ki: 1.907
pid_Kd: 184.064
min_temp: 0
max_temp: 250
min_extrude_temp: 170

#pressure_advance: 0.0
#   The amount of raw filament to push into the extruder during
#   extruder acceleration. An equal amount of filament is retracted
#   during deceleration. It is measured in millimeters per
#   millimeter/second. The default is 0, which disables pressure
#   advance.
#pressure_advance_lookahead_time: 0.010
#   A time (in seconds) to "look ahead" at future extrusion moves when
#   calculating pressure advance. This is used to reduce the
#   application of pressure advance during cornering moves that would
#   otherwise cause retraction followed immediately by pressure
#   buildup. This setting only applies if pressure_advance is
#   non-zero. The default is 0.010 (10 milliseconds).


[tmc2208 stepper_x]
uart_pin: P1.16
microsteps: 16
interpolate: False
run_current: 0.6
stealthchop_threshold: 300
#driver_PWM_AUTOGRAD: False
driver_PWM_GRAD: 27
driver_PWM_OFS: 70

[tmc2208 stepper_y]
uart_pin: P1.8
microsteps: 16
interpolate: False
run_current: 0.6
stealthchop_threshold: 300
#driver_PWM_AUTOGRAD: False
driver_PWM_GRAD: 27
driver_PWM_OFS: 78

[tmc2208 stepper_z]
uart_pin: P1.10
microsteps: 16
interpolate: False
run_current: 0.6
stealthchop_threshold: 300
#driver_PWM_AUTOGRAD: False
driver_PWM_GRAD: 14
driver_PWM_OFS: 191

[tmc2209 extruder]
uart_pin: P1.0
microsteps: 16
interpolate: False
run_current: 0.6
stealthchop_threshold: 300
#driver_PWM_AUTOGRAD: False
driver_PWM_GRAD: 23
driver_PWM_OFS: 76

#hold_current: 0.3
#sense_resistor: 0.110
#stealthchop_threshold: 0
#driver_IHOLDDELAY: 8
#driver_TPOWERDOWN: 0
#driver_BLANK_TIME_SELECT: 1
#driver_TOFF: 4
#driver_HEND: 7
#driver_HSTRT: 0
#driver_PWM_AUTOSCALE: True
#driver_PWM_FREQ: 1
#driver_PWM_GRAD: 4
#driver_PWM_AMPL: 128



[heater_bed]
heater_pin: P2.5
sensor_type: ATC Semitec 104GT-2
sensor_pin: P0.24
control: watermark
#pid_Kp: 426.68
#pid_Ki: 78.92
#pid_Kd: 576.61
min_temp: 0
max_temp: 70

[fan]
pin: P2.6

[heater_fan hotend_fan]
# Hotend fan
pin: P1.22
kick_start_time: 0.500
heater: extruder
heater_temp: 50.0

[mcu]
serial: /dev/serial/by-id/usb-Klipper_lpc1769_22F0FF158088CDAE72E32C57C12000F5-if00

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 500
max_z_velocity: 15
max_z_accel: 100

[static_digital_output leds]
pins: P1.18, P1.19, P1.20, P1.21, P4.28

# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
[display]
lcd_type: st7920
cs_pin: P0.16
sclk_pin: P0.15
sid_pin: P0.18
encoder_pins: ^P3.26, ^P3.25
click_pin: ^!P1.30


[probe]
pin: P1.29
#   Probe detection pin. This parameter must be provided.
x_offset: 0.0
#   The distance (in mm) between the probe and the nozzle along the
#   x-axis. The default is 0.
y_offset: 60.0
#   The distance (in mm) between the probe and the nozzle along the
#   y-axis. The default is 0.
z_offset: 0.0
#   The distance (in mm) between the bed and the nozzle when the probe
#   triggers. This parameter must be provided.
speed: 5.0
#   Speed (in mm/s) of the Z axis when probing. The default is 5mm/s.

measurement_script: /home/pi/scripts/measure.py
measurement_z: 5
sample_retract_dist: 2.0


# Mesh Bed Leveling. One may define a [bed_mesh] config section
# to enable move transformations that offset the z axis based
# on a mesh generated from probed points. Note that bed_mesh
# and bed_tilt are incompatible, both cannot be defined.
[bed_mesh]
speed: 50
#   The speed (in mm/s) of non-probing moves during the
#   calibration. The default is 50.
#horizontal_move_z: 5
#   The height (in mm) that the head should be commanded to move to
#   just prior to starting a probe operation. The default is 5.
mesh_min: 20,80
#min_point: 20, 80
#   An X,Y point defining the minimum coordinate to probe on
#   the bed. Note that this refers to the nozzle position,
#   and take care that you do not define a point that will move
#   the probe off of the bed. This parameter must be provided.
mesh_max: 280, 280
#   An X,Y point defining the maximum coordinate to probe on
#   the bed. Follow the same precautions as listed in min_point.
#   Also note that this does not necessarily define the last point
#   probed, only the maximum coordinate. This parameter must be provided.
probe_count: 11,11
#   A comma separated pair of integer values (X,Y) defining the number
#   of points to probe along each axis. A single value is also valid,
#   in which case that value will be for both axes. Default is 3,3
#   which probes a 3x3 grid.
#fade_start: 1.0
#   The z-axis position in which to start phasing z-adjustment out.
#   Default is 1.0.
#fade_end: 10.0
#   The z-axis position in which phase out is complete. If this
#   value is less than or equal to fade_start then phasing out
#   is disabled. Default is 10.0.
#split_delta_z: .025
#   The amount of Z difference (in mm) along a move that will
#   trigger a split. Default is .025.
#move_check_distance: 5.0
#   The distance (in mm) along a move to check for split_delta_z.
#   This is also the minimum length that a move can be split. Default
#   is 5.0.
#mesh_pps: 2,2
mesh_pps: 0
#   A comma separated pair of integers (X,Y) defining the number of
#   points per segment to interpolate in the mesh along each axis. A
#   "segment" can be defined as the space between each probed
#   point. The user may enter a single value which will be applied
#   to both axes.  Default is 2,2.
#algorithm: lagrange
#   The interpolation algorthm to use. May be either "langrange"
#   or "bicubic". This option will not affect 3x3 grids, which
#   are forced to use lagrange sampling.  Default is lagrange.
#bicubic_tension: .2
#   When using the bicubic algoritm the tension parameter above
#   may be applied to change the amount of slope interpolated.
#   Larger numbers will increase the amount of slope, which
#   results in more curvature in the mesh. Default is .2.
#manual_probe:
#   See the manual_probe option of [bed_tilt] for details. The default
#   is false if a [probe] config section is present and true otherwise.
relative_reference_index: 0
horizontal_move_z: 10

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [OLD_bed_mesh default]
#*# points =
#*# 	0.000000, -0.070000, -0.110000, -0.120000, -0.160000, -0.210000, -0.210000, -0.190000, -0.150000, -0.130000, -0.060000
#*# 	0.010000, -0.060000, -0.110000, -0.130000, -0.170000, -0.190000, -0.180000, -0.170000, -0.140000, -0.090000, -0.020000
#*# 	0.020000, -0.040000, -0.100000, -0.130000, -0.150000, -0.160000, -0.170000, -0.140000, -0.110000, -0.050000, 0.020000
#*# 	0.000000, -0.060000, -0.100000, -0.110000, -0.150000, -0.150000, -0.160000, -0.110000, -0.090000, -0.030000, 0.020000
#*# 	0.000000, -0.060000, -0.080000, -0.090000, -0.150000, -0.160000, -0.150000, -0.070000, -0.060000, -0.030000, 0.030000
#*# 	0.000000, -0.070000, -0.090000, -0.100000, -0.150000, -0.160000, -0.150000, -0.080000, -0.060000, -0.030000, 0.020000
#*# 	0.010000, -0.050000, -0.100000, -0.120000, -0.150000, -0.160000, -0.160000, -0.110000, -0.080000, -0.040000, 0.030000
#*# 	0.000000, -0.050000, -0.110000, -0.140000, -0.150000, -0.160000, -0.150000, -0.130000, -0.080000, -0.030000, 0.030000
#*# 	0.000000, -0.040000, -0.110000, -0.130000, -0.150000, -0.150000, -0.140000, -0.120000, -0.080000, -0.020000, 0.050000
#*# 	-0.010000, -0.050000, -0.100000, -0.110000, -0.140000, -0.150000, -0.140000, -0.100000, -0.060000, -0.030000, 0.040000
#*# 	-0.010000, -0.030000, -0.070000, -0.060000, -0.120000, -0.130000, -0.120000, -0.060000, -0.040000, -0.020000, 0.040000
#*# x_count = 11
#*# y_count = 11
#*# min_x = 20.0
#*# max_x = 280.0
#*# min_y = 80.0
#*# max_y = 280.0
#*# x_offset = 0.0
#*# y_offset = 60.0
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = direct
#*# tension = 0.2
